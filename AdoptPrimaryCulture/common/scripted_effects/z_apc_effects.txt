#-----------------------------------------------------------------------------------------
# Alternative set_primary_culture_cleanup_effect
# Long explanations lest I forget everything
#-----------------------------------------------------------------------------------------
z_apc_set_primary_culture_cleanup_effect = {
	# Most of the mod uses a *country_culture* scope, but in this particular case, we need a *culture* scope.
	# AFAIK, only pops hold both types. So let's identify our target *culture* by finding a pop that has the matching *country_culture*.
	random_owned_province = {
		limit = {
			any_pops_in_province = {
				# In theory, we could scope to our mission-saved *country_culture* scope like this:
				# this.country_culture = scope:z_apc_new_cultural_majority
				# But we want to be able to use this effect outside of the mission, for example for testing it.
				# Since the target *culture* is the only *country_culture* having an APC modifier:
				this.country_culture = { z_apc_has_any_cultural_majority_modifier_trigger = yes }
				# And just to make sure:
				NOT = { this.country_culture = root.country_culture }
			}
		}
		random_pops_in_province = {
			limit = {
				this.country_culture = { z_apc_has_any_cultural_majority_modifier_trigger = yes }
				NOT = { this.country_culture = root.country_culture }
			}
			# Ladies and gentlemen, we got him. Let's save his culture type.
			this.culture = { save_scope_as = z_apc_change_to_this_culture }
		}
	}
	# Using that scope, we can change the primary culture using the Vanilla/Invictus effect that cleans up everything as needed
	set_primary_culture_cleanup_effect = {
		NEW_PRIMARY_CULTURE = scope:z_apc_change_to_this_culture
		MAKE_OLD_CULTURE_INTEGRATED = $MAKE_OLD_CULTURE_INTEGRATED$
	}
	# But we're not done yet, oh no.
	# The problem, when doing this, is that the game fails to recalculate the correct amount of noble cultures, thus applying an incorrect malus to the new primary culture.
	# From testing, the only way I've found to force a recalculation is to change the country rank.
	# That means temporarily changing the number of owned provinces.
	# (I've also tried to remove/readd every pop from the previous primary culture, but that didn't fix it.)
	# 
	# 3. Fix wrong number of noble cultures count
	#		Option 1: Reduce the number of provinces until reaching a lower rank
	#			Problem: cannot apply to OPMs
	#			Problem: removes non-permanent province modifiers
	#			Problem: might remove cultural rights if there are no longer pops of those cultures during the transition
	#		Option 2: Increase the number of provinces until reaching a higher rank
	#			Problem: cannot apply to great powers
	#			Problem: needs enough provinces to feed to the country
	#			Warning: must not destroy foreign countries and must not feed from non-AI countries
	#		My current solution:
	#			Use option 2 except for great powers (we assume there will always be enough provinces to feed in 99.9% of the cases)
	#			Use option 1 for great powers
	#			Avoid removing/feeding provinces that have a high amount of pops, since they are more likely to have province modifiers
	#		Alright, let's do it:
	switch = {
		trigger = rank
		# Ideally, for mods that change the rank thresholds, the numbers here should be adjusted, else the fix might not work (no crash, just no fix)
		# TARGET = number of provinces the country must drop below in order to change rank
		# migrant_horde = from 0 to 0 -> No reset possible
		migrant_horde = { z_apc_reset_rank_effect = { TARGET = 0 } } # This rank = from 0 to 0
		city_power = { z_apc_reset_rank_effect = { TARGET = 1 } } # This rank = from 1 to 1
		local_power = { z_apc_reset_rank_effect = { TARGET = 25 } } # This rank = from 2 to 24
		regional_power = { z_apc_reset_rank_effect = { TARGET = 100 } } # This rank = from 25 to 99
		major_power = { z_apc_reset_rank_effect = { TARGET = 100 } } # This rank = from 100 to 499
		great_power = { z_apc_reset_rank_effect = { TARGET = 500 } } # This rank = from 500
	}
}

#-----------------------------------------------------------------------------------------
# Fix wrong number of noble cultures count
#-----------------------------------------------------------------------------------------
z_apc_reset_rank_effect = {
	
}
	
	
	
	
	
	# Unfortunately, no fix for OPMs because it relies on resetting the country rank
	# Need to find a better way :(
	# hidden_effect = {
		# random_owned_province = {
			# limit = {
				# NOT = { this = root.capital_scope }
			# }
			# create_country = { save_scope_as = z_apc_noble_cultures_count_bugfix }
		# }
		# every_owned_province = {
			# limit = {
				# NOT = { this = root.capital_scope }
			# }
			# set_owned_by = scope:z_apc_noble_cultures_count_bugfix
		# }
		# scope:z_apc_noble_cultures_count_bugfix = {
			# every_owned_province = { set_owned_by = root }
		# }
	# }

#-----------------------------------------------------------------------------------------
# Find a Cultural Majority, then update Cultural Majority or remove invalid Cultural Majority
#-----------------------------------------------------------------------------------------
z_apc_find_cultural_majority_effect = {
	# Before anything, make sure the primary culture isn't considered a Cultural Majority
	if = {
		limit = {
			root.country_culture = { z_apc_has_any_cultural_majority_modifier_trigger = yes }
		}
		root.country_culture = { z_apc_remove_all_cultural_majority_modifiers_effect = yes }
	}
	# Then, check whether a Cultural Majority exists
	if = {
		limit = {
			# Only possible if the APC mission is not ongoing or has never been completed
			NOT = { has_variable = z_apc_mission_ongoing }
			# Only possible if there's any culture other than the primary one
			any_country_culture = {
				NOT = { this = root.country_culture }
			}
		}
		# ---------------------------------------------------------------------------------------------------------------
		# Try to find a Cultural Majority in the entire COUNTRY
		if = {
			limit = { num_of_cities > 1 } # Only valid is capital_scope isn't the only owned territory
			z_apc_find_cultural_majority_in_zone_effect = { ZONE = country }
		}
		# If no Cultural Majority was found in the COUNTRY, try to find one in the capital REGION
		if = {
			limit = {
				NOT = {
					exists = scope:z_apc_found_cultural_majority_in_country
				}
			}
			if = {
				limit = { num_of_cities > 1 } # Only valid is capital_scope isn't the only owned territory
				z_apc_find_cultural_majority_in_zone_effect = { ZONE = capital_region }
			}
		}
		# If no Cultural Majority was found in the capital REGION, try to find one in the capital AREA
		if = {
			limit = {
				NOR = {
					exists = scope:z_apc_found_cultural_majority_in_country
					exists = scope:z_apc_found_cultural_majority_in_capital_region
				}
			}
			if = {
				limit = { num_of_cities > 1 } # Only valid is capital_scope isn't the only owned territory
				z_apc_find_cultural_majority_in_zone_effect = { ZONE = capital_area }
			}
		}
		# If no Cultural Majority was found in the capital AREA, try to find one in the capital CITY
		if = {
			limit = {
				NOR = {
					exists = scope:z_apc_found_cultural_majority_in_country
					exists = scope:z_apc_found_cultural_majority_in_capital_region
					exists = scope:z_apc_found_cultural_majority_in_capital_area
				}
			}
			z_apc_find_cultural_majority_in_zone_effect = { ZONE = capital_city }
		}
		# ---------------------------------------------------------------------------------------------------------------
		z_apc_update_cultural_majority_effect = yes # Fire events based on scenario
	}
}

#-----------------------------------------------------------------------------------------
# Find the culture that has the most pops in the designated ZONE, then check if it's a Cultural Majority
#-----------------------------------------------------------------------------------------
z_apc_find_cultural_majority_in_zone_effect = {
	# Make a list of all cultures that need to be compared
	every_country_culture = {
		limit = {
			NOT = { this = root.country_culture }
		}
		add_to_list = z_apc_comparison_cultures_list
	}
	# Pick one at random to be the first culture to be compared
	random_country_culture = {
		limit = {
			is_in_list = z_apc_comparison_cultures_list
		}
		# ...save it as culture_A, which is assumed to have the most pops in the designated ZONE
		save_scope_as = z_apc_culture_A
		# ...remove it from the list of cultures to be compared...
		remove_from_list = z_apc_comparison_cultures_list
		# ...and store population in cache
		root = {
			set_variable = {
				name = z_apc_culture_A_$ZONE$_population_cache
				value = z_apc_culture_A_$ZONE$_population
			}
		}
	}
	# Among all the cultures in the list, find the one that has the most pops in the designated ZONE
	while = {
		# Run loop as long as there are cultures to be compared
		limit = {
			any_country_culture = {
				is_in_list = z_apc_comparison_cultures_list
			}
		}
		# Pick one at random...
		random_country_culture = {											
			limit = {
				is_in_list = z_apc_comparison_cultures_list
			}
			# ...save it as culture_B...
			save_scope_as = z_apc_culture_B
			# ...remove it from the list of cultures to be compared...
			remove_from_list = z_apc_comparison_cultures_list
			# ...and store population in cache
			root = {
				set_variable = {
					name = z_apc_culture_B_$ZONE$_population_cache
					value = z_apc_culture_B_$ZONE$_population
				}
			}
			# Now compare culture_A and culture_B in the designated ZONE
			if = {
				limit = {
					root = { z_apc_culture_A_$ZONE$_population_cache < z_apc_culture_B_$ZONE$_population_cache }
				}
				# If culture_B > culture_A in the designated ZONE, update cache for culture_A...
				root = {
					set_variable = {
						name = z_apc_culture_A_$ZONE$_population_cache
						value = var:z_apc_culture_B_$ZONE$_population_cache
					}
				}
				# ...then culture_B becomes the new culture_A
				scope:z_apc_culture_B = {
					save_scope_as = z_apc_culture_A
				}
			}
			# Clear cache for culture_B
			root = { remove_variable = z_apc_culture_B_$ZONE$_population_cache }
		}
	}
	# At this point, culture_A is the one that has the most pops in the designated ZONE
	# So the next step is to check whether culture_A is a Cultural Majority (i.e. if it's above the set threshold for the designated ZONE)
	set_variable = {
		name = z_apc_total_population_in_$ZONE$_cache
		value = z_apc_total_population_in_$ZONE$
	}
	if = {
		limit = {
			z_apc_culture_pc_$ZONE$ > z_apc_cultural_majority_threshold_$ZONE$
		}
		scope:z_apc_culture_A = {
			save_scope_as = z_apc_found_cultural_majority
			save_scope_as = z_apc_found_cultural_majority_in_$ZONE$
		}
	}
	# Clear list
	every_in_list = {
		list = z_apc_comparison_cultures_list
		remove_from_list = z_apc_comparison_cultures_list
	}
	# Clear cache for culture_A
	remove_variable = z_apc_culture_A_$ZONE$_population_cache
	# Clear cache for ZONE
	remove_variable = z_apc_total_population_in_$ZONE$_cache
}

#-----------------------------------------------------------------------------------------
# Update Cultural Majority modifier based on all possible scenarios
#-----------------------------------------------------------------------------------------
z_apc_update_cultural_majority_effect = {
	# No Cultural Majority was found...
	if = {
		limit = {
			NOT = { exists = scope:z_apc_found_cultural_majority }
		}
		# ...and no Cultural Majority already exists
		if = {
			limit = {
				NOT = {
					any_country_culture = { z_apc_has_any_cultural_majority_modifier_trigger = yes }
				}
			}
			# SCENARIO 0: Do nothing
		}
		# ...but a Cultural Majority already exists
		else = {
			# SCENARIO 1: Remove Cultural Majority modifier from the old Cultural Majority
			# Event
			random_country_culture = {
				limit = { z_apc_has_any_cultural_majority_modifier_trigger = yes }
				save_scope_as = z_apc_old_cultural_majority
			}
			random_country_culture = {
				limit = { this = root.country_culture }
				save_scope_as = z_apc_ruling_minority
			}
			trigger_event = z_apc_common.1
		}
	}
	# A Cultural Majority was found...
	else = {
		# ...and no Cultural Majority already exists
		if = {
			limit = {
				NOT = {
					any_country_culture = { z_apc_has_any_cultural_majority_modifier_trigger = yes }
				}
			}
			# SCENARIO 2: Add Cultural Majority modifier to the new Cultural Majority (also game start scenario)
			# Event
			random_country_culture = {
				limit = { this = root.country_culture }
				save_scope_as = z_apc_ruling_minority
			}
			trigger_event = z_apc_common.2
		}
		# ...and it's already a Cultural Majority
		else_if = {
			limit = {
				scope:z_apc_found_cultural_majority = { z_apc_has_any_cultural_majority_modifier_trigger = yes }
			}
			# SCENARIO 3: Update Cultural Majority modifier, if necessary (no event)
			# Event
			scope:z_apc_found_cultural_majority = {
				z_apc_remove_all_cultural_majority_modifiers_effect = yes
				z_apc_add_cultural_majority_modifier_effect = yes
			}
		}
		# ...but there's already another Cultural Majority
		else = {
			# SCENARIO 4: Add Cultural Majority modifier to the new Cultural Majority + Remove Cultural Majority modifier from the old Cultural Majority
			# Event
			random_country_culture = {
				limit = { z_apc_has_any_cultural_majority_modifier_trigger = yes }
				save_scope_as = z_apc_old_cultural_majority
			}
			random_country_culture = {
				limit = { this = root.country_culture }
				save_scope_as = z_apc_ruling_minority
			}
			trigger_event = z_apc_common.4
		}
	}
}

#-----------------------------------------------------------------------------------------
# Add Cultural Majority modifier
#-----------------------------------------------------------------------------------------
z_apc_add_cultural_majority_modifier_effect = {
	if = {
		limit = {
			exists = scope:z_apc_found_cultural_majority_in_country
			this = scope:z_apc_found_cultural_majority_in_country
		}
		add_country_culture_modifier = {
			name = z_apc_cultural_majority_in_country_modifier
			duration = -1
		}
	}
	else_if = {
		limit = {
			exists = scope:z_apc_found_cultural_majority_in_capital_region
			this = scope:z_apc_found_cultural_majority_in_capital_region
		}
		add_country_culture_modifier = {
			name = z_apc_cultural_majority_in_capital_region_modifier
			duration = -1
		}
	}
	else_if = {
		limit = {
			exists = scope:z_apc_found_cultural_majority_in_capital_area
			this = scope:z_apc_found_cultural_majority_in_capital_area
		}
		add_country_culture_modifier = {
			name = z_apc_cultural_majority_in_capital_area_modifier
			duration = -1
		}
	}
	else_if = {
		limit = {
			exists = scope:z_apc_found_cultural_majority_in_capital_city
			this = scope:z_apc_found_cultural_majority_in_capital_city
		}
		add_country_culture_modifier = {
			name = z_apc_cultural_majority_in_capital_city_modifier
			duration = -1
		}
	}
}

#-----------------------------------------------------------------------------------------
# Remove all Cultural Majority modifiers
#-----------------------------------------------------------------------------------------
z_apc_remove_all_cultural_majority_modifiers_effect = {
	if = {
		limit = { has_country_culture_modifier = z_apc_cultural_majority_in_country_modifier }
		remove_country_culture_modifier = z_apc_cultural_majority_in_country_modifier
	}
	if = {
		limit = { has_country_culture_modifier = z_apc_cultural_majority_in_capital_region_modifier }
		remove_country_culture_modifier = z_apc_cultural_majority_in_capital_region_modifier
	}
	if = {
		limit = { has_country_culture_modifier = z_apc_cultural_majority_in_capital_area_modifier }
		remove_country_culture_modifier = z_apc_cultural_majority_in_capital_area_modifier
	}
	if = {
		limit = { has_country_culture_modifier = z_apc_cultural_majority_in_capital_city_modifier }
		remove_country_culture_modifier = z_apc_cultural_majority_in_capital_city_modifier
	}
}

#-----------------------------------------------------------------------------------------
# Clear mission variables (on abort or completion)
#-----------------------------------------------------------------------------------------
z_apc_mission_clear_variables_effect = {
	if = {
		limit = { has_variable = z_apc_mission_ongoing }
		remove_variable = z_apc_mission_ongoing
	}
	if = {
		limit = { has_variable = z_apc_mission_ctp_current }
		remove_variable = z_apc_mission_ctp_current
	}
	if = {
		limit = { has_variable = z_apc_mission_already_integrated_citizens }
		remove_variable = z_apc_mission_already_integrated_citizens
	}
	if = {
		limit = { has_variable = z_apc_mission_already_integrated_nobles }
		remove_variable = z_apc_mission_already_integrated_nobles
	}
	if = {
		limit = { has_variable = z_apc_mission_assimilation_flag }
		remove_variable = z_apc_mission_assimilation_flag
	}
	if = {
		limit = { has_variable = z_apc_mission_replacement_flag }
		remove_variable = z_apc_mission_replacement_flag
	}
}

#-----------------------------------------------------------------------------------------
# Add 1 Cultural Transition point
#-----------------------------------------------------------------------------------------
z_apc_mission_add_ctp_effect = {
	if = {
		limit = { has_variable = z_apc_mission_ctp_current }
		change_variable = {
			name = z_apc_mission_ctp_current
			add = $VALUE$
		}
	}
	custom_tooltip = z_apc_mission_add_$VALUE$_ctp_effect_tt
}